<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NanoAnalytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f7f8fa;
      --surface: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #6366f1;
      --accent-light: #eef2ff;
      --danger: #ef4444;
      --radius: 10px;
      --shadow: 0 1px 6px rgba(0,0,0,.07);
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }

    /* â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-width: 380px;
      margin: 18vh auto 0;
      padding: 2rem;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: 0 4px 24px rgba(0,0,0,.09);
    }
    #login h1 {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #login .logo { font-size: 1.6rem; }
    #login label { font-size: .8rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
    #login input {
      width: 100%;
      padding: .55rem .75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: .95rem;
      outline: none;
      transition: border-color .15s;
    }
    #login input:focus { border-color: var(--accent); }
    #login button {
      padding: .6rem 1rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }
    #login button:hover { opacity: .88; }
    #login .error { color: var(--danger); font-size: .85rem; }
    #login .hint { font-size: .8rem; color: var(--muted); }

    /* â”€â”€ App shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app { display: none; max-width: 1280px; margin: 0 auto; padding: 1.5rem; }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: .75rem;
      margin-bottom: 1.5rem;
    }
    header h1 { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
    .controls { display: flex; align-items: center; gap: .5rem; flex-wrap: wrap; }
    .controls select, .controls input[type="date"] {
      padding: .4rem .6rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: .85rem;
      background: var(--surface);
      cursor: pointer;
    }
    .controls .site-label {
      font-size: .8rem;
      color: var(--muted);
      font-weight: 600;
    }
    .controls #cur-site {
      font-weight: 700;
      color: var(--accent);
    }
    .btn-logout {
      padding: .38rem .75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      font-size: .82rem;
      cursor: pointer;
      color: var(--muted);
    }
    .btn-logout:hover { color: var(--danger); border-color: var(--danger); }

    /* â”€â”€ Stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      box-shadow: var(--shadow);
    }
    .card .label {
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
      font-weight: 600;
    }
    .card .value {
      font-size: 2.2rem;
      font-weight: 800;
      margin-top: .2rem;
      color: var(--text);
    }

    /* â”€â”€ Charts row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .charts-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 720px) { .charts-row { grid-template-columns: 1fr; } }
    .chart-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: var(--shadow);
    }
    .chart-box h2 {
      font-size: .82rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
      font-weight: 600;
      margin-bottom: .75rem;
    }

    /* â”€â”€ Tables row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tables-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    .table-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: var(--shadow);
    }
    .table-box h2 {
      font-size: .82rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
      font-weight: 600;
      margin-bottom: .75rem;
    }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table td {
      padding: .4rem .2rem;
      border-bottom: 1px solid var(--border);
      font-size: .88rem;
    }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table .count {
      text-align: right;
      font-weight: 700;
      color: var(--accent);
      white-space: nowrap;
      padding-left: .75rem;
    }
    .data-table .path {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* â”€â”€ Live map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .live-box {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }
    .live-header {
      display: flex;
      align-items: center;
      gap: .6rem;
      margin-bottom: .75rem;
    }
    .live-header h2 {
      font-size: .82rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    .live-dot {
      width: 8px; height: 8px;
      background: #22c55e;
      border-radius: 50%;
      display: inline-block;
      animation: livepulse 2s infinite;
    }
    @keyframes livepulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(34,197,94,.5); }
      50%      { box-shadow: 0 0 0 6px rgba(34,197,94,0); }
    }
    .active-badge {
      font-size: .95rem;
      font-weight: 800;
      color: #22c55e;
    }
    .live-hint {
      font-size: .75rem;
      color: var(--muted);
      margin-left: auto;
    }
    #live-map {
      height: 340px;
      border-radius: 6px;
      overflow: hidden;
      z-index: 0;
    }

    /* â”€â”€ Loading / empty states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .skeleton { color: var(--muted); font-style: italic; font-size: .85rem; }
    .empty { color: var(--muted); font-size: .85rem; }
  </style>
</head>
<body>

<!-- â”€â”€ Login form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login">
  <h1><span class="logo">ðŸ“Š</span> NanoAnalytics</h1>
  <div>
    <label for="site-inp">Site (hostname)</label>
    <input id="site-inp" type="text" placeholder="example.com" autocomplete="off" spellcheck="false">
  </div>
  <div>
    <label for="token-inp">API Token</label>
    <input id="token-inp" type="password" placeholder="Paste your API_TOKEN here">
  </div>
  <button id="login-btn">Open Dashboard</button>
  <p id="login-err" class="error" style="display:none"></p>
  <p class="hint">Find your API token in your hosting platform's Environment Variables panel.</p>
</div>

<!-- â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app">
  <header>
    <h1><span>ðŸ“Š</span> NanoAnalytics
      <span class="site-label">â€” </span><span id="cur-site"></span>
    </h1>
    <div class="controls">
      <select id="range-sel">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="custom">Custom range</option>
      </select>
      <input type="date" id="start-date" style="display:none">
      <input type="date" id="end-date"   style="display:none">
      <button class="btn-logout" id="logout-btn">Logout</button>
    </div>
  </header>

  <div class="cards">
    <div class="card">
      <div class="label">Page Views</div>
      <div class="value" id="stat-views">â€”</div>
    </div>
    <div class="card">
      <div class="label">Sessions</div>
      <div class="value" id="stat-sessions">â€”</div>
    </div>
  </div>

  <div class="live-box">
    <div class="live-header">
      <h2><span class="live-dot"></span> Live</h2>
      <span class="active-badge" id="active-count">â€”</span>
      <span style="font-size:.8rem;color:var(--muted)">active now</span>
      <span class="live-hint">last 5 min Â· refreshes every 30s</span>
    </div>
    <div id="live-map"></div>
  </div>

  <div class="charts-row">
    <div class="chart-box">
      <h2>Traffic over time</h2>
      <canvas id="chart-ts" height="80"></canvas>
    </div>
    <div class="chart-box">
      <h2>Devices</h2>
      <canvas id="chart-devices" height="80"></canvas>
    </div>
  </div>

  <div class="tables-row">
    <div class="table-box">
      <h2>Top Pages</h2>
      <table class="data-table" id="tbl-pages"><tr><td class="skeleton">Loadingâ€¦</td></tr></table>
    </div>
    <div class="table-box">
      <h2>Top Referrers</h2>
      <table class="data-table" id="tbl-refs"><tr><td class="skeleton">Loadingâ€¦</td></tr></table>
    </div>
    <div class="table-box">
      <h2>Top Languages</h2>
      <table class="data-table" id="tbl-langs"><tr><td class="skeleton">Loadingâ€¦</td></tr></table>
    </div>
    <div class="table-box">
      <h2>Hostnames</h2>
      <table class="data-table" id="tbl-hosts"><tr><td class="skeleton">Loadingâ€¦</td></tr></table>
    </div>
    <div class="table-box">
      <h2>Top Countries</h2>
      <table class="data-table" id="tbl-countries"><tr><td class="skeleton">Loadingâ€¦</td></tr></table>
    </div>
  </div>
</div>

<script>
(() => {
  const LS_TOKEN = 'na_token';
  const LS_SITE  = 'na_site';

  // â”€â”€ Country centroids [lat, lng] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const CENTROIDS = {
    AF:[33.9,67.7],AL:[41.2,20.2],DZ:[28.0,1.7],AO:[-11.2,17.9],AR:[-38.4,-63.6],
    AM:[40.1,45.0],AU:[-25.3,133.8],AT:[47.5,14.6],AZ:[40.1,47.6],BH:[26.0,50.6],
    BD:[23.7,90.4],BY:[53.7,28.0],BE:[50.5,4.5],BJ:[9.3,2.3],BO:[-16.3,-63.6],
    BA:[44.0,17.7],BR:[-14.2,-51.9],BG:[42.7,25.5],BF:[12.4,-1.6],BI:[-3.4,29.9],
    KH:[12.6,105.0],CM:[3.9,11.5],CA:[56.1,-106.3],CF:[6.6,20.9],TD:[15.5,18.7],
    CL:[-35.7,-71.5],CN:[35.9,104.2],CO:[4.6,-74.3],CG:[-0.2,15.8],CR:[9.7,-83.8],
    HR:[45.1,15.2],CU:[21.5,-77.8],CY:[35.1,33.4],CZ:[49.8,15.5],DK:[56.3,9.5],
    DO:[18.7,-70.2],EC:[-1.8,-78.2],EG:[26.8,30.8],SV:[13.8,-88.9],EE:[58.6,25.0],
    ET:[9.1,40.5],FI:[61.9,25.7],FR:[46.2,2.2],GA:[-0.8,11.6],GE:[42.3,43.4],
    DE:[51.2,10.5],GH:[7.9,-1.0],GR:[39.1,22.0],GT:[15.8,-90.2],GN:[11.0,-10.9],
    HT:[18.9,-72.3],HN:[15.2,-86.2],HU:[47.2,19.5],IS:[64.9,-18.6],IN:[20.6,78.9],
    ID:[-0.8,113.9],IR:[32.4,53.7],IQ:[33.2,43.7],IE:[53.4,-8.2],IL:[31.0,34.9],
    IT:[41.9,12.6],JM:[18.1,-77.3],JP:[36.2,138.3],JO:[30.6,36.2],KZ:[48.0,66.9],
    KE:[-0.0,37.9],KW:[29.3,47.5],KG:[41.2,74.8],LV:[56.9,24.6],LB:[33.9,35.9],
    LY:[26.3,17.2],LT:[55.2,24.0],LU:[49.8,6.1],MG:[-18.8,46.9],MW:[-13.3,34.3],
    MY:[4.2,108.0],ML:[17.6,-4.0],MT:[35.9,14.4],MX:[23.6,-102.6],MD:[47.4,28.4],
    MN:[46.9,103.8],ME:[42.7,19.4],MA:[31.8,-7.1],MZ:[-18.7,35.5],MM:[21.9,96.0],
    NA:[-22.0,17.1],NP:[28.4,84.1],NL:[52.1,5.3],NZ:[-40.9,174.9],NI:[12.9,-85.2],
    NE:[17.6,8.1],NG:[9.1,8.7],MK:[41.6,21.7],NO:[60.5,8.5],OM:[21.5,55.9],
    PK:[30.4,69.3],PA:[8.5,-80.8],PY:[-23.4,-58.4],PE:[-9.2,-75.0],PH:[12.9,121.8],
    PL:[51.9,19.1],PT:[39.4,-8.2],QA:[25.4,51.2],RO:[45.9,24.9],RU:[61.5,105.3],
    RW:[-1.9,29.9],SA:[24.0,45.0],SN:[14.5,-14.5],RS:[44.0,21.0],SL:[8.5,-11.8],
    SK:[48.7,19.7],SI:[46.1,14.8],SO:[5.2,46.2],ZA:[-30.6,22.9],KR:[35.9,127.8],
    ES:[40.5,-3.7],LK:[7.9,80.8],SD:[12.9,30.2],SE:[60.1,18.6],CH:[46.8,8.2],
    SY:[35.0,38.0],TW:[23.7,121.0],TJ:[38.9,71.3],TZ:[-6.4,35.0],TH:[15.9,100.9],
    TL:[-8.9,125.7],TG:[8.6,0.8],TN:[34.0,9.0],TR:[38.9,35.2],TM:[38.97,59.6],
    UG:[1.4,32.3],UA:[48.4,31.2],AE:[23.4,53.8],GB:[55.4,-3.4],US:[37.1,-95.7],
    UY:[-32.5,-55.8],UZ:[41.4,64.6],VE:[6.4,-66.6],VN:[14.1,108.3],YE:[15.6,48.5],
    ZM:[-13.1,27.8],ZW:[-20.0,30.0],PS:[31.9,35.2],HK:[22.3,114.2],SG:[1.3,103.8],
    PG:[-6.3,143.9],FJ:[-17.7,178.1],MV:[4.2,73.5],BT:[27.5,90.4],KP:[40.3,127.5],
    TT:[10.7,-61.2],BB:[13.2,-59.6],JE:[49.2,-2.1],CW:[12.2,-69.0],
  };

  let tsChart  = null;
  let devChart = null;
  let liveMap  = null;
  let liveMarkers = [];

  // â”€â”€ Live map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initLiveMap() {
    liveMap = L.map('live-map', { zoomControl: true, attributionControl: false })
               .setView([20, 10], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19, subdomains: 'abcd',
    }).addTo(liveMap);
    L.control.attribution({ prefix: 'Â© <a href="https://carto.com">CARTO</a> Â© <a href="https://osm.org/copyright">OSM</a>' }).addTo(liveMap);
  }

  async function loadLive() {
    const token = localStorage.getItem(LS_TOKEN);
    const site  = localStorage.getItem(LS_SITE);
    if (!token || !site || !liveMap) return;
    try {
      const r = await fetch(`/api/active?site=${encodeURIComponent(site)}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!r.ok) return;
      const data = await r.json();

      document.getElementById('active-count').textContent = data.active;

      // Remove old markers
      liveMarkers.forEach(m => liveMap.removeLayer(m));
      liveMarkers = [];

      // Place new markers
      (data.countries || []).forEach(({ country, sessions }) => {
        const pos = CENTROIDS[country];
        if (!pos) return;
        const radius = Math.max(7, Math.min(38, sessions * 9));
        const m = L.circleMarker(pos, {
          radius,
          fillColor: '#6366f1',
          color: '#fff',
          weight: 1.5,
          fillOpacity: 0.65,
        }).bindTooltip(
          `${flag(country)} ${country} â€” ${sessions} active`,
          { permanent: false, direction: 'top' }
        ).addTo(liveMap);
        liveMarkers.push(m);
      });
    } catch(e) { /* silent */ }
  }

  let _liveInterval = null;

  // â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function init() {
    const token = localStorage.getItem(LS_TOKEN);
    const site  = localStorage.getItem(LS_SITE);
    if (!token || !site) {
      document.getElementById('login').style.display = 'flex';
      document.getElementById('app').style.display   = 'none';
      return;
    }
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display   = 'block';
    document.getElementById('cur-site').textContent = site;

    // Init map once (needs the div to be visible)
    if (!liveMap) initLiveMap();

    load();
    loadLive();
    if (_liveInterval) clearInterval(_liveInterval);
    _liveInterval = setInterval(loadLive, 30000);
  }

  // â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('login-btn').addEventListener('click', async () => {
    const token = document.getElementById('token-inp').value.trim();
    const site  = document.getElementById('site-inp').value.trim().replace(/^https?:\/\//, '').replace(/\/$/, '');
    const err   = document.getElementById('login-err');
    err.style.display = 'none';
    if (!token || !site) { showErr('Please enter both a site and an API token.'); return; }

    // Validate by hitting a protected endpoint
    const r = await fetch(`/api/pageviews?site=${encodeURIComponent(site)}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (r.status === 401) { showErr('Wrong token â€” try again.'); return; }

    localStorage.setItem(LS_TOKEN, token);
    localStorage.setItem(LS_SITE,  site);
    init();
  });

  function showErr(msg) {
    const el = document.getElementById('login-err');
    el.textContent  = msg;
    el.style.display = 'block';
  }

  // Enter key on inputs
  ['site-inp', 'token-inp'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('login-btn').click();
    });
  });

  // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('logout-btn').addEventListener('click', () => {
    localStorage.removeItem(LS_TOKEN);
    localStorage.removeItem(LS_SITE);
    location.reload();
  });

  // â”€â”€ Date range â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('range-sel').addEventListener('change', function() {
    const custom = this.value === 'custom';
    document.getElementById('start-date').style.display = custom ? '' : 'none';
    document.getElementById('end-date').style.display   = custom ? '' : 'none';
    if (!custom) load();
  });
  ['start-date', 'end-date'].forEach(id => {
    document.getElementById(id).addEventListener('change', load);
  });

  function getRange() {
    const sel = document.getElementById('range-sel').value;
    const now = Math.floor(Date.now() / 1000);
    if (sel === 'custom') {
      const s = document.getElementById('start-date').value;
      const e = document.getElementById('end-date').value;
      return {
        start: s ? Math.floor(new Date(s).getTime() / 1000) : now - 86400 * 30,
        end:   e ? Math.floor(new Date(e).getTime() / 1000) : now,
      };
    }
    return { start: now - 86400 * parseInt(sel), end: now };
  }

  // â”€â”€ API helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function api(path) {
    const token = localStorage.getItem(LS_TOKEN);
    const site  = localStorage.getItem(LS_SITE);
    const { start, end } = getRange();
    const qs = new URLSearchParams({ site, start, end, limit: 10 });
    const r = await fetch(`${path}?${qs}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (r.status === 401) { localStorage.removeItem(LS_TOKEN); location.reload(); }
    return r.json();
  }

  // â”€â”€ Load all data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function load() {
    try {
      const [pv, pgs, refs, ts, devs, langs, hosts, ctries] = await Promise.all([
        api('/api/pageviews'),
        api('/api/pages'),
        api('/api/referrers'),
        api('/api/timeseries'),
        api('/api/devices'),
        api('/api/languages'),
        api('/api/hostnames'),
        api('/api/countries'),
      ]);

      // Stat cards
      document.getElementById('stat-views').textContent    = fmt(pv.views);
      document.getElementById('stat-sessions').textContent = fmt(pv.sessions);

      // Timeseries line chart
      const tsLabels = ts.map(r => r.day);
      const tsData   = ts.map(r => r.views);
      if (tsChart) tsChart.destroy();
      tsChart = new Chart(document.getElementById('chart-ts'), {
        type: 'line',
        data: {
          labels: tsLabels,
          datasets: [{
            label: 'Views',
            data: tsData,
            fill: true,
            tension: 0.3,
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99,102,241,.1)',
            pointRadius: tsLabels.length > 60 ? 0 : 3,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } },
            y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
          },
        }
      });

      // Devices doughnut
      if (devChart) devChart.destroy();
      devChart = new Chart(document.getElementById('chart-devices'), {
        type: 'doughnut',
        data: {
          labels: ['Desktop', 'Mobile', 'Tablet', 'Unknown'],
          datasets: [{
            data: [devs.desktop, devs.mobile, devs.tablet, devs.unknown],
            backgroundColor: ['#6366f1', '#f59e0b', '#10b981', '#d1d5db'],
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } },
          cutout: '65%',
        }
      });

      // Top Pages table
      renderTable('tbl-pages', pgs, r => [r.path, fmt(r.views)], 'No pages tracked yet.');

      // Top Referrers table
      renderTable('tbl-refs', refs, r => [r.ref || '(direct)', fmt(r.views)], 'No referrers yet.');

      // Top Languages table
      renderTable('tbl-langs', langs, r => [r.lang, fmt(r.views)], 'No language data yet.');

      // Hostnames breakdown
      renderTable('tbl-hosts', hosts, r => [r.site, fmt(r.views)], 'No hostname data yet.');

      // Countries
      renderTable('tbl-countries', ctries, r => [flag(r.country) + ' ' + r.country, fmt(r.views)], 'No country data yet.');

    } catch (e) {
      console.error('NanoAnalytics load error:', e);
    }
  }

  function renderTable(id, rows, mapper, emptyMsg) {
    const tbl = document.getElementById(id);
    if (!rows || rows.length === 0) {
      tbl.innerHTML = `<tr><td class="empty">${emptyMsg}</td></tr>`;
      return;
    }
    tbl.innerHTML = rows.map(r => {
      const [label, count] = mapper(r);
      return `<tr>
        <td class="path" title="${escHtml(label)}">${escHtml(label)}</td>
        <td class="count">${count}</td>
      </tr>`;
    }).join('');
  }

  function fmt(n) {
    if (n == null) return 'â€”';
    return Number(n).toLocaleString();
  }

  function flag(code) {
    if (!code || code.length !== 2) return 'ðŸŒ';
    return String.fromCodePoint(...[...code.toUpperCase()].map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
  }

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  init();
})();
</script>
</body>
</html>
